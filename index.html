<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Validador de CNPJ Profissional</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 950px; }
        h2 { color: #2c3e50; text-align: center; margin-bottom: 20px; }
        .upload-section { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; border: 2px dashed #3498db; padding: 20px; border-radius: 8px; text-align: center; }
        button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 5px; }
        .btn-primary { background: #3498db; color: white; width: 100%; font-size: 16px; }
        .btn-success { background: #27ae60; color: white; display: none; }
        .btn-danger { background: #c0392b; color: white; display: none; }
        .btn-info { background: #8e44ad; color: white; display: none; }
        .btn-warning { background: #e67e22; color: white; display: none; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 25px; margin: 20px 0; display: none; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #2ecc71; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
        #log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.5; }
        .status-2 { color: #2ecc71; }
        .status-8 { color: #e74c3c; }
        .line-info { color: #bdc3c7; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè¢ Validador de CNPJ</h2>
    
    <div class="upload-section">
        <input type="file" id="fileInput" accept=".txt">
        <button id="btnIniciar" class="btn-primary">üöÄ Iniciar Valida√ß√£o</button>
    </div>

    <div class="progress-container" id="progressCont">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="log">Aguardando arquivo...</div>

    <div style="text-align: center; margin-top: 20px;">
        <button id="btnExportarTudo" class="btn-success">üì• Relat√≥rio Completo</button>
        <button id="btnExportarNaoAtivos" class="btn-danger">üì• Baixar N√£o Ativos</button>
        <button id="btnExportarDuplicados" class="btn-info">üì• Baixar Repetidos</button>
        <button id="btnExportarErros" class="btn-warning">üì• Inconsist√™ncias</button>
    </div>
</div>

<script>
    const statusTraducao = { "1": "NULA", "2": "ATIVA", "3": "SUSPENSA", "4": "INAPTA", "8": "BAIXADA" };
    let baseSucesso = []; let baseNaoAtivos = []; let baseFalhas = []; let baseDuplicados = [];

    const btnIniciar = document.getElementById('btnIniciar');
    const fileInput = document.getElementById('fileInput');
    const logArea = document.getElementById('log');

    btnIniciar.onclick = async () => {
        const file = fileInput.files[0];
        if (!file) return alert("Selecione um arquivo!");

        const texto = await file.text();
        const linhasBrutas = texto.split(/\r?\n/);
        
        let baseProcessamento = [];
        linhasBrutas.forEach((conteudo, index) => {
            let limpo = conteudo.replace(/\D/g, "");
            if (limpo.length === 14) {
                // Sincronizei para usar 'doc' como nome da propriedade
                baseProcessamento.push({ doc: limpo, linha: index + 1 });
            }
        });

        const vistos = new Map(); 
        const unicos = [];
        baseDuplicados = [];

        baseProcessamento.forEach(item => {
            if (vistos.has(item.doc)) {
                // Removi res.nome daqui, pois a API ainda n√£o foi consultada
                baseDuplicados.push(`LINHA ORIGINAL: ${item.linha} | CNPJ: ${item.doc} (Repetido da linha ${vistos.get(item.doc)})`);
            } else {
                vistos.set(item.doc, item.linha);
                unicos.push(item);
            }
        });

        baseSucesso = []; baseNaoAtivos = []; baseFalhas = [];
        logArea.innerHTML = `üìÑ Linhas v√°lidas: ${baseProcessamento.length} | √önicos: ${unicos.length}<br><hr>`;
        
        document.getElementById('progressCont').style.display = "block";
        btnIniciar.disabled = true;

        for (let i = 0; i < unicos.length; i++) {
            const item = unicos[i];
            const perc = Math.round(((i + 1) / unicos.length) * 100);
            document.getElementById('progressBar').style.width = perc + "%";
            document.getElementById('progressBar').innerText = perc + "%";
            
            logArea.innerHTML += `<span class="line-info">[L:${item.linha}]</span> Verificando ${item.doc}... `;
            let res = await consultarAPI(item.doc);

            if (res.ok) {
                const statusTxt = statusTraducao[res.status] || res.status;
                logArea.innerHTML += `<span class="status-${res.status}">[OK] ${res.nome} | ${statusTxt}</span><br>`;
                
                const registroCompleto = `LINHA: ${item.linha} | CNPJ: ${item.doc} | NOME: ${res.nome} | STATUS: ${statusTxt}`;
                baseSucesso.push(registroCompleto);
                
                if (res.status !== "2" && res.status !== 2) {
                    baseNaoAtivos.push(registroCompleto);
                }
            } else {
                logArea.innerHTML += `<span class="status-8">[FALHA]</span><br>`;
                baseFalhas.push(`LINHA: ${item.linha} | CNPJ: ${item.doc} | MOTIVO: N√£o encontrado na API`);
            }
            logArea.scrollTop = logArea.scrollHeight;
            await new Promise(r => setTimeout(r, 1500)); // Rate limit anti-bloqueio
        }
        finalizar();
    };

    async function consultarAPI(doc) {
        try {
            const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${doc}`);
            if (r.ok) {
                const d = await r.json();
                return { ok: true, nome: d.razao_social, status: String(d.situacao_cadastral) };
            }
        } catch (e) {}
        return { ok: false };
    }

    function finalizar() {
        btnIniciar.disabled = false;
        logArea.innerHTML += "<br><b>‚úÖ Conclu√≠do!</b>";
        document.getElementById('btnExportarTudo').style.display = "inline-block";
        if (baseNaoAtivos.length > 0) document.getElementById('btnExportarNaoAtivos').style.display = "inline-block";
        if (baseDuplicados.length > 0) document.getElementById('btnExportarDuplicados').style.display = "inline-block";
        if (baseFalhas.length > 0) document.getElementById('btnExportarErros').style.display = "inline-block";
    }

    function baixar(dados, nome) {
        const blob = new Blob([dados.join('\n')], { type: 'text/plain;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = nome; a.click();
    }

    document.getElementById('btnExportarTudo').onclick = () => baixar(baseSucesso, "relatorio_completo.txt");
    document.getElementById('btnExportarNaoAtivos').onclick = () => baixar(baseNaoAtivos, "nao_ativos.txt");
    document.getElementById('btnExportarDuplicados').onclick = () => baixar(baseDuplicados, "duplicados.txt");
    document.getElementById('btnExportarErros').onclick = () => baixar(baseFalhas, "inconsistencias.txt");
</script>
</body>
</html>
